package main

import (
	"encoding/json"
	"flag"
	"fmt"
	"log"
	"os"
	"strings"
	"time"

	"github.com/lcalzada-xor/hackaton_cyber_arena_UCM/internal/config"
	"github.com/lcalzada-xor/hackaton_cyber_arena_UCM/internal/models"
	"github.com/lcalzada-xor/hackaton_cyber_arena_UCM/internal/ui"
	"github.com/lcalzada-xor/hackaton_cyber_arena_UCM/pkg/exploitdb"
	"github.com/lcalzada-xor/hackaton_cyber_arena_UCM/pkg/nvd"
	"github.com/lcalzada-xor/hackaton_cyber_arena_UCM/pkg/sorter"
)

func main() {
	var (
		palabraClave, claveAPI, severidad, fechaInicio, fechaFin, cpe, cwe, salida string
		cvssV2Severidad, modFechaInicio, modFechaFin, fuente                       string
		ordenarPor, direccionOrden                                                 string
		limite                                                                     int
	)

	// Load Config
	cfg, err := config.CargarConfiguracion()
	if err != nil {
		// Just warn, don't fail
		fmt.Fprintf(os.Stderr, "%sAdvertencia: Fallo al cargar configuración: %v%s\n", ui.ColorGray, err, ui.ColorReset)
	}

	// Search
	flag.StringVar(&palabraClave, "keyword", "", "Palabra clave a buscar")
	flag.StringVar(&palabraClave, "k", "", "Palabra clave (corto)")

	// Filters
	flag.StringVar(&severidad, "severity", "", "Severidad CVSS v3")
	flag.StringVar(&severidad, "s", "", "Severidad (corto)")

	flag.StringVar(&fechaInicio, "start-date", "", "Fecha de Inicio")
	flag.StringVar(&fechaInicio, "d", "", "Fecha de Inicio (corto)")

	flag.StringVar(&fechaFin, "end-date", "", "Fecha de Fin")
	flag.StringVar(&fechaFin, "e", "", "Fecha de Fin (corto)")

	flag.StringVar(&cpe, "cpe", "", "Nombre CPE")
	flag.StringVar(&cpe, "c", "", "CPE (corto)")

	flag.StringVar(&cwe, "cwe", "", "ID CWE")
	flag.StringVar(&cwe, "w", "", "CWE (corto)")

	flag.StringVar(&cvssV2Severidad, "cvss-v2-severity", "", "Severidad CVSS v2")
	flag.StringVar(&cvssV2Severidad, "S", "", "Severidad CVSS v2 (corto)")

	flag.StringVar(&modFechaInicio, "mod-start-date", "", "Fecha de Inicio de Última Modificación")
	flag.StringVar(&modFechaInicio, "m", "", "Fecha de Inicio Modificación (corto)")

	flag.StringVar(&modFechaFin, "mod-end-date", "", "Fecha de Fin de Última Modificación")
	flag.StringVar(&modFechaFin, "M", "", "Fecha de Fin Modificación (corto)")

	flag.StringVar(&fuente, "source", "", "Identificador de Fuente")
	flag.StringVar(&fuente, "i", "", "Identificador de Fuente (corto)")

	// Output & Config
	flag.IntVar(&limite, "limit", cfg.DefaultLimit, "Límite de resultados")
	flag.IntVar(&limite, "l", cfg.DefaultLimit, "Límite (corto)")

	flag.StringVar(&salida, "output", cfg.OutputFormat, "Formato de salida")
	flag.StringVar(&salida, "o", cfg.OutputFormat, "Salida (corto)")

	flag.StringVar(&ordenarPor, "sort", "", "Ordenar por (published, modified, score)")
	flag.StringVar(&ordenarPor, "O", "", "Ordenar por (corto)")

	flag.StringVar(&direccionOrden, "direction", "desc", "Dirección de ordenamiento (asc, desc)")
	flag.StringVar(&direccionOrden, "D", "desc", "Dirección (corto)")

	flag.StringVar(&claveAPI, "apikey", cfg.APIKey, "Clave API")
	flag.StringVar(&claveAPI, "a", cfg.APIKey, "Clave API (corto)")

	flag.Usage = func() {
		h := ui.ColorOrange + "Uso de cve-search:\n" + ui.ColorReset
		fmt.Fprint(os.Stderr, h)

		printCategory := func(name string, flags ...string) {
			fmt.Fprintf(os.Stderr, "\n%s%s:%s\n", ui.ColorLightOrange, name, ui.ColorReset)
			for _, f := range flags {
				fmt.Fprintln(os.Stderr, f)
			}
		}

		printCategory("BÚSQUEDA",
			"  -k, --keyword string     Palabra clave a buscar (ej., 'log4j')",
		)

		printCategory("FILTROS",
			"  -s, --severity string    Severidad CVSS v3 (LOW, MEDIUM, HIGH, CRITICAL)",
			"  -d, --start-date string  Fecha de Inicio (AAAA-MM-DD)",
			"  -e, --end-date string    Fecha de Fin (AAAA-MM-DD)",
			"  -c, --cpe string         Nombre CPE (ej., cpe:2.3:a:apache:log4j...)",
			"  -w, --cwe string         ID CWE (ej., CWE-79)",
			"  -S, --cvss-v2-severity   Severidad CVSS v2 (LOW, MEDIUM, HIGH)",
			"  -m, --mod-start-date     Fecha de Inicio de Última Modificación (AAAA-MM-DD)",
			"  -M, --mod-end-date       Fecha de Fin de Última Modificación (AAAA-MM-DD)",
			"  -i, --source             Identificador de Fuente (ej., cve@mitre.org)",
		)

		printCategory("SALIDA Y CONFIGURACIÓN",
			"  -l, --limit int          Número de resultados a devolver (por defecto 10)",
			"  -o, --output string      Formato de salida (human, json) (por defecto \"human\")",
			"  -O, --sort string        Ordenar por (published, modified, score)",
			"  -D, --direction string   Dirección de ordenamiento (asc, desc) (por defecto \"desc\")",
			"  -a, --apikey string      Clave API del NVD (opcional)",
		)

		fmt.Fprintln(os.Stderr, "")
	}

	flag.Parse()

	// Validate that at least one search criteria is provided
	if palabraClave == "" && cpe == "" && cwe == "" && severidad == "" && fechaInicio == "" && cvssV2Severidad == "" && modFechaInicio == "" && fuente == "" {
		fmt.Println(ui.ColorOrange + "Por favor, proporcione al menos un criterio de búsqueda (palabra clave, cpe, cwe, etc.)" + ui.ColorReset)
		// Custom usage will be printed if we call flag.Usage()
		flag.Usage()
		os.Exit(1)
	}

	// Format dates if provided
	var pubFechaInicio, pubFechaFin, ultModFechaInicio, ultModFechaFin string
	if fechaInicio != "" {
		pubFechaInicio = fechaInicio + "T00:00:00.000"
	}
	if fechaFin != "" {
		pubFechaFin = fechaFin + "T23:59:59.999"
	}
	if modFechaInicio != "" {
		ultModFechaInicio = modFechaInicio + "T00:00:00.000"
	}
	if modFechaFin != "" {
		ultModFechaFin = modFechaFin + "T23:59:59.999"
	} else if modFechaInicio != "" {
		// If mod-start-date is provided but mod-end-date is not, default to today (UTC)
		ultModFechaFin = time.Now().UTC().Format("2006-01-02") + "T23:59:59.999"
	}

	cliente := nvd.NuevoCliente(claveAPI)

	// Initialize ExploitDB Client
	edbClient, err := exploitdb.NewClient()
	if err != nil {
		// Silently fail or warn? Let's warn to stderr but continue
		// fmt.Fprintf(os.Stderr, "Warning: Failed to initialize exploitdb: %v\n", err)
	} else {
		if err := edbClient.StartServer(); err != nil {
			// fmt.Fprintf(os.Stderr, "Warning: Failed to start exploitdb server: %v\n", err)
			edbClient = nil // Disable if server fails
		} else {
			defer edbClient.StopServer()
		}
	}

	if salida == "human" {
		fmt.Printf(ui.ColorOrange + "Buscando CVEs...\n" + ui.ColorReset)
		if palabraClave != "" {
			fmt.Printf(ui.ColorOrange+"Palabra clave: %s%s\n"+ui.ColorReset, ui.ColorHighlight, palabraClave)
		}
	}

	parametros := nvd.ParametrosBusqueda{
		KeywordSearch:    palabraClave,
		ResultsPerPage:   limite,
		CvssV3Severity:   severidad,
		PubStartDate:     pubFechaInicio,
		PubEndDate:       pubFechaFin,
		CpeName:          cpe,
		CweId:            cwe,
		CvssV2Severity:   cvssV2Severidad,
		LastModStartDate: ultModFechaInicio,
		LastModEndDate:   ultModFechaFin,
		SourceIdentifier: fuente,
	}

	resultados, err := cliente.BuscarCVEs(parametros)
	if err != nil {
		log.Fatalf("Error buscando CVEs: %v", err)
	}

	// Enrich with Exploits
	if edbClient != nil {
		for i := range resultados.Vulnerabilities {
			cveID := resultados.Vulnerabilities[i].CVE.ID
			exploits, err := edbClient.Search(cveID)
			if err == nil && len(exploits) > 0 {
				var modelExploits []models.Exploit
				for _, e := range exploits {
					modelExploits = append(modelExploits, models.Exploit{
						ID:          e.ID,
						Name:        e.Name,
						Type:        e.Type,
						URL:         e.URL,
						Description: e.Description,
						Date:        e.Date,
						Author:      e.Author,
					})
				}
				resultados.Vulnerabilities[i].Exploits = modelExploits
			}
		}
	}

	// Client-side Sorting
	if ordenarPor != "" {
		sorter.SortVulnerabilities(resultados.Vulnerabilities, ordenarPor, direccionOrden)
	}

	if salida == "json" {
		enc := json.NewEncoder(os.Stdout)
		enc.SetIndent("", "  ")
		if err := enc.Encode(resultados); err != nil {
			log.Fatalf("Error codificando JSON: %v", err)
		}
		return
	}

	fmt.Printf(ui.ColorLightOrange+"Encontrados %d resultados totales. Mostrando top %d:\n"+ui.ColorReset, resultados.TotalResults, len(resultados.Vulnerabilities))
	fmt.Println(ui.ColorGray + "---------------------------------------------------" + ui.ColorReset)

	for _, v := range resultados.Vulnerabilities {
		cve := v.CVE

		// Highlight keyword in description
		desc := cve.ObtenerDescripcion("en")
		if palabraClave != "" {
			desc = ui.ResaltarPalabraClave(desc, palabraClave)
		}

		fmt.Printf("%sID:%s %s\n", ui.ColorDarkOrange, ui.ColorReset, ui.ResaltarPalabraClave(cve.ID, palabraClave))
		fmt.Printf("%sFuente:%s %s\n", ui.ColorLightOrange, ui.ColorReset, cve.SourceIdentifier)
		fmt.Printf("%sPublicado:%s %s\n", ui.ColorLightOrange, ui.ColorReset, cve.Published)
		fmt.Printf("%sÚltima Modificación:%s %s\n", ui.ColorLightOrange, ui.ColorReset, cve.LastModified)
		fmt.Printf("%sEstado:%s %s\n", ui.ColorLightOrange, ui.ColorReset, cve.VulnStatus)

		// Weaknesses
		if len(cve.Weaknesses) > 0 {
			var cwes []string
			for _, w := range cve.Weaknesses {
				for _, d := range w.Description {
					if d.Lang == "en" {
						cwes = append(cwes, d.Value)
					}
				}
			}
			if len(cwes) > 0 {
				fmt.Printf("%sDebilidades:%s %s\n", ui.ColorLightOrange, ui.ColorReset, strings.Join(cwes, ", "))
			}
		}

		fmt.Printf("%sDescripción:%s %s\n", ui.ColorLightOrange, ui.ColorReset, desc)

		// Print CVSS Score if available
		if len(cve.Metrics.CvssMetricV31) > 0 {
			score := cve.Metrics.CvssMetricV31[0].CvssData.BaseScore
			severity := cve.Metrics.CvssMetricV31[0].CvssData.BaseSeverity
			fmt.Printf("%sPuntuación CVSS v3.1:%s %.1f (%s)\n", ui.ColorOrange, ui.ColorReset, score, severity)
		} else if len(cve.Metrics.CvssMetricV30) > 0 {
			score := cve.Metrics.CvssMetricV30[0].CvssData.BaseScore
			severity := cve.Metrics.CvssMetricV30[0].CvssData.BaseSeverity
			fmt.Printf("%sPuntuación CVSS v3.0:%s %.1f (%s)\n", ui.ColorOrange, ui.ColorReset, score, severity)
		} else if len(cve.Metrics.CvssMetricV2) > 0 {
			score := cve.Metrics.CvssMetricV2[0].CvssData.BaseScore
			fmt.Printf("%sPuntuación CVSS v2:%s %.1f\n", ui.ColorOrange, ui.ColorReset, score)
		}

		// References (limit to 3)
		if len(cve.References) > 0 {
			fmt.Printf("%sReferencias:%s\n", ui.ColorLightOrange, ui.ColorReset)
			count := 0
			for _, ref := range cve.References {
				if count >= 3 {
					break
				}
				fmt.Printf("  - %s\n", ref.URL)
				count++
			}
			if len(cve.References) > 3 {
				fmt.Printf("  ... y %d más\n", len(cve.References)-3)
			}
		}

		// Exploits
		if len(v.Exploits) > 0 {
			fmt.Printf("%sExploits Detectados (%d):%s\n", ui.ColorRed, len(v.Exploits), ui.ColorReset)
			for _, e := range v.Exploits {
				title := e.Name
				if title == "" {
					title = e.Description
				}

				typeStr := ""
				if e.Type != "" {
					typeStr = fmt.Sprintf("[%s] ", e.Type)
				}

				fmt.Printf("  - %s%s\n    %s%s\n", typeStr, title, ui.ColorGray, e.URL)
				fmt.Print(ui.ColorReset) // Reset color after URL
			}
		}

		fmt.Println()
		fmt.Println(ui.ColorGray + "────────────────────────────────────────────────────────────────────────────────" + ui.ColorReset)
		fmt.Println()
	}
}
